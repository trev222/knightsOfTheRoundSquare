<!DOCTYPE html>
<head>
	<title>Knights of the round square</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
</head>
<style type="text/css">
*{margin:0;padding:0;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}.board{float:left;padding:5px}.board.success{background-color:rgba(0,255,0,.2)}.board.failed{background-color:rgba(255,0,0,.2)}.board.selected{background-color:rgba(255,255,0,.2)}.board.selected.success{box-shadow:inset 0 0 3px 5px rgba(0,255,0,.5)}.board.selected.failed{box-shadow:inset 0 0 3px 5px rgba(255,0,0,.5)}.box{margin:3px;height:20px;width:20px;border:1px solid #000;float:left}.box.on{background-color:#00f}.box.beenHereAlready{background-color:red}.box.start{background-color:green}.box.traversedBlock{background-color:rgba(255,0,255,.4)}.box.active{border:4px solid orange}#new,#playButton{margin:10px;width:100%;max-width:200px;height:40px}
</style>
<body>
	<button id="new">new</button>
	<button id="playButton">start/stop</button>
</body>

<script type="text/javascript">
function boardFinished(e){$("#"+e+" .off:not(.start)").length||$("#"+e+" .beenHereAlready:not(.start)").length?(console.log("Failed! "+e+" was not completed!"),$("#"+e).addClass("failed")):(console.log("Success! "+e+" has been completed!"),$("#"+e).addClass("success")),activeBoards.indexOf(e)>-1&&boardsToSplice.push(e)}function spliceFinishedBoards(){for(var e=0;e<boardsToSplice.length;e++){var o=boardsToSplice[e],s=activeBoards.indexOf(o);s>-1&&activeBoards.splice(s,1)}}function createBoard(e,o,s,t,n){activeBoards[activeBoards.length]=e,$("body").append('<div class="board" size="'+s+"x"+o+'" id="'+e+'"></div>');for(var a=1,r=1;r<=o;){for(a=1;a<=s;)$("#"+e).append('<div id="'+e+"-"+a+"-"+r+'" class="box off" x="'+a+'" y="'+r+'"></div>'),a++;$("#"+e).append('<div style="clear:both;"></div>'),r++}chooseStart(e,o,s,t,n)}function chooseStart(e,o,s,t,n){if(void 0==t)var t=parseInt(Math.floor(Math.random()*s+1));if(void 0==n)var n=parseInt(Math.floor(Math.random()*o+1));$("#"+e+"-"+t+"-"+n).addClass("start active on").removeClass("off"),createActiveOpenBlockArray(e,t,n)}function createActiveOpenBlockArray(e,o,s){activeOpenBlockArray[e]=[];for(var t=0,n=0,a=1;a<=4;a++){if(1==a)t=o,n=s-1;else if(2==a)t=o,n=s+1;else if(3==a)t=o+1,n=s;else{if(4!=a)continue;t=o-1,n=s}doesBlockExist(e,t,n)&&activeOpenBlockArray[e].push(t+"-"+n)}}function moveToNext(e,o,s){1==s&&($("#"+e).hasClass("userTouched")||$("#"+e).addClass("userTouched"));var t=parseInt($("#"+e+" .active").attr("x")),n=parseInt($("#"+e+" .active").attr("y"));switch(o){case"up":n--;break;case"down":n++;break;case"right":t++;break;case"left":t--;break;default:console.log("moveToNext(): direction not recognized: "+o)}var a=t+"-"+n,r=activeOpenBlockArray[e].indexOf(a);-1!=r&&activeOpenBlockArray[e].splice(r,1),moveToThisElement="#"+e+"-"+t+"-"+n,doesBlockExist(e,t,n)?(blockHasClass("on",e,t,n)&&($(moveToThisElement).addClass("beenHereAlready"),boardFinished(e)),blockHasClass("start",e,t,n)&&boardFinished(e),$("#"+e+" .active").removeClass("active"),$(moveToThisElement).addClass("active on").removeClass("off")):1==s?console.log("You can't move there because that block doesn't exist."):(console.log("moveToNext(): asked to move to this element but it doesn't exist: "+moveToThisElement),boardFinished(e))}function doesBlockExist(e,o,s){return!!$("#"+e+"-"+o+"-"+s).length}function blockHasClass(e,o,s,t){return!!$("#"+o+"-"+s+"-"+t).hasClass(e)}function blockIsOpenAndExists(e,o,s,t){return doesBlockExist(e,o,s)&&blockHasClass("off",e,o,s)?(void 0!=t&&console.log("Block x:"+o+" y:"+s+" exists and is open"),!0):(void 0!=t&&console.log("Block x:"+o+" y:"+s+" does not exist and/or is not open"),!1)}function isNextToActiveBlock(e,o,s){for(var t=1;t<=4;t++){if(1==t)n="up";else if(2==t)n="down";else if(3==t)n="right";else{if(4!=t)continue;var n="left"}var a=moveCordsOneBlock(n,o,s),r=parseInt(a.x),i=parseInt(a.y);if(doesBlockExist(e,r,i)&&blockHasClass("active",e,r,i))return!0}return!1}function viewBlockMoveOptions(e,o,s,t){var a=[];a.legitMoves=[];for(var r=0;r<4;r++){switch(r){case 0:var i="up",l=s-1,c=o,d=-1;break;case 1:var i="down",l=s+1,c=o,d=1;break;case 2:i="right";l=s,c=o+1,d=1;break;case 3:i="left";l=s,c=o-1,d=-1}for(a[i]=[],a[i].moveableAmount=0,a[i].ranIntoStartBlock=!1,n=0,max=maxMoveRange(e);n<=max;){if(!blockIsOpenAndExists(e,c,l)&&!blockHasClass("traversedBlock",e,c,l)){blockHasClass("start",e,c,l)&&(a[i].ranIntoStartBlock=!0);break}a[i].moveableAmount++,0==r||1==r?l+=d:c+=d}a[i].moveableAmount>=1&&a.legitMoves.push(i)}return a}function moveCordsOneBlock(e,o,s){return"up"==e?s--:"down"==e?s++:"right"==e?o++:"left"==e?o--:console.log("moveCordsOneBlock() direction not recognized: "+e),{x:o,y:s}}function getOppositeDirections(e){if("up"==e)var o="down",s="right",t="left";else if("down"==e)var o="up",s="right",t="left";else if("right"==e)var o="left",s="up",t="down";else{if("left"!=e)return console.log("getOppositeDirections() direction not recognized: "+e),!1;var o="right",s="up",t="down"}return{opp:o,od1:s,od2:t}}function boardTotalBlocks(e){var o=$("#"+e).attr("size").split("x");return parseInt(o[0])*parseInt(o[1])}function maxMoveRange(e){var o=$("#"+e).attr("size").split("x"),s=parseInt(o[0]),t=parseInt(o[1]);return s>t?s:t}function percentageOfTheBoardTraversed(e){var o=boardTotalBlocks(e);return $("#"+e+" .on").length/o}function closestMove(e,o){bestMove="none";for(var s=1;s<=4;s++){if(1==s)t="up";else if(2==s)t="down";else if(3==s)t="right";else{if(4!=s)continue;var t="left"}0!=e[t].moveableAmount&&(void 0!=o&&-1==o.indexOf(t)||("none"==bestMove||e[t].moveableAmount<e[bestMove].moveableAmount)&&(bestMove=t))}return bestMove}function traverseAllPathsIsPossible(e,o,s){var t=!1,n="null";if(activeOpenBlockArray[e].length>=2&&!$("#"+e).hasClass("userTouched"))return t=!0,{boolean:t,openOn:n};if(!activeOpenBlockArray[e][0])return boardFinished(e),{boolean:t,openOn:n};activeOpenBlockArray[e][0];var a=activeOpenBlockArray[e][0].split("-"),r=parseInt(a[0]),i=parseInt(a[1]);if(o==r&&s==i)return n="opposite",{boolean:t,openOn:n};var l=$("#"+e+" .off").length;$("#"+e+"-"+o+"-"+s).addClass("traversedBlock"),$("#"+e+"-"+r+"-"+i).addClass("traversedBlock");for(var c=[{x:r,y:i}];c.length>=1;){for(var d=viewBlockMoveOptions(e,r=c[0].x,i=c[0].y),v=1;v<=4;v++){if(1==v)u="up";else if(2==v)u="down";else if(3==v)u="right";else{if(4!=v)continue;u="left"}if(0!=d[u].moveableAmount){var f=moveCordsOneBlock(u,r,i),p=f.x,k=f.y;blockHasClass("traversedBlock",e,p,k)||blockHasClass("on",e,p,k)||($("#"+e+"-"+p+"-"+k).addClass("traversedBlock"),c.push(f))}}c.shift()}if(l==$("#"+e+" .traversedBlock").length)t=!0;else for(var h=1;h<=4;h++){if(1==h)u="up";else if(2==h)u="down";else if(3==h)u="right";else{if(4!=h)continue;var u="left"}var b=moveCordsOneBlock(u,o,s),g=parseInt(b.x),x=parseInt(b.y);if(blockIsOpenAndExists(e,g,x)&&!blockHasClass("traversedBlock",e,g,x)){for(var O=1;O<=4;O++){if(1==O)m="up";else if(2==O)m="down";else if(3==O)m="right";else{if(4!=O)continue;var m="left"}var B=moveCordsOneBlock(m,g,x),T=parseInt(B.x),C=parseInt(B.y);if(blockIsOpenAndExists(e,T,C)&&!blockHasClass("traversedBlock",e,T,C)&&isNextToActiveBlock(e,T,C))break}var y=C-1,A=C+1,I=T+1,w=T-1;if(blockIsOpenAndExists(e,T,y)&&blockIsOpenAndExists(e,T,A)&&!blockIsOpenAndExists(e,I,C)&&!blockIsOpenAndExists(e,w,C))continue;if(blockIsOpenAndExists(e,I,C)&&blockIsOpenAndExists(e,w,C)&&!blockIsOpenAndExists(e,T,y)&&!blockIsOpenAndExists(e,T,A))continue;n=u;break}}return $("#"+e+" .traversedBlock").removeClass("traversedBlock"),{boolean:t,openOn:n}}function doHolesNeedToBeFilled(e){for(var o=parseInt($("#"+e+" .active").attr("x")),s=parseInt($("#"+e+" .active").attr("y")),t=1;t<=4;t++){if(1==t)n="up";else if(2==t)n="down";else if(3==t)n="right";else{if(4!=t)continue;var n="left"}var a=moveCordsOneBlock(n,o,s),r=parseInt(a.x),i=parseInt(a.y);if(blockIsOpenAndExists(e,r,i)){for(var l=0,c=1;c<=4;c++){if(1==c)d="up";else if(2==c)d="down";else if(3==c)d="right";else{if(4!=c)continue;var d="left"}var v=(a=moveCordsOneBlock(d,r,i)).x,f=a.y;(blockIsOpenAndExists(e,v,f)||blockHasClass("start",e,v,f))&&l++}if(1==l)return{boolean:!0,fillHoleSide:n}}}return{boolean:!1}}function willThisBlockCreateA2x2Trap(e,o,s){for(var t=viewBlockMoveOptions(e,o,s,1),n=0;n<t.legitMoves.length;n++){var a=[],r=getOppositeDirections(B=t.legitMoves[n]),i=moveCordsOneBlock(B,o,s),l=i.x,c=i.y,d=viewBlockMoveOptions(e,cords_x,c,1);if(a.center1={x:l,y:c},-1!=d.legitMoves.indexOf(B)&&(-1!=d.legitMoves.indexOf(r.od1)||-1!=d.legitMoves.indexOf(r.od2))){for(var v=0;v<d.legitMoves.length;v++){var f=d.legitMoves[v],p=moveCordsOneBlock(f,l,c),k=p.x,h=p.y;if(f==B)a.center2={x:k,y:h};else{moveCordsOneBlock(f,k,h);var u=p.x,b=p.y;if(blockIsOpenAndExists(e,u,b)){void 0==a.side1?(a.side1={x:k,y:h},a.side2={x:u,y:b}):(a.third1={x:k,y:h},a.third2={x:u,y:b});continue}}}if(!(6==a.length||a.length<=3)){console.log("we've got a live one"),console.log(a);for(var g=[],x=1;x<=4;x++){if(1==x)O="center1";else if(2==x)O="center2";else if(3==x)O="side1";else{if(4!=x)continue;var O="side2"}g[O]="closed";for(var m=1;m<=4;m++){if(1==m)B="up";else if(2==m)B="down";else if(3==m)B="right";else{if(4!=m)continue;var B="left"}var T=moveCordsOneBlock(f,a[O].x,a[O].y),C=T.x,y=T.y;if(!(C==a.center1.x&&y==a.center1.y||C==a.center2.x&&y==a.center2.y||C==a.side1.x&&y==a.side1.y||C==a.side2.x&&y==a.side2.y)&&(doesBlockExist(e,C,y)&&(blockHasClass(className,e,C,y)||blockHasClass(className,e,C,y)))){g[O]="open";break}}if("open"==g.center1&&"closed"==g.center2&&"closed"==g.side1||"open"==g.center2&&"closed"==g.center1&&"closed"==g.side2||"open"==g.side1&&"closed"==g.center1&&"closed"==g.side2||"open"==g.side2&&"closed"==g.center2&&"closed"==g.side1)return console.log("willThisBlockCreateA2x2Trap: true"),{boolean:!0}}}}}return console.log("willThisBlockCreateA2x2Trap: false"),{boolean:!1}}function thinkTank(){if(0==activeBoards.length)return clearInterval(thinkTankLoop_timer),void(thinkTankLoop_timer=0);for(a=0;a<activeBoards.length;a++){var e=activeBoards[a],o=parseInt($("#"+e+" .active").attr("x")),s=parseInt($("#"+e+" .active").attr("y")),t=viewBlockMoveOptions(e,o,s),n="none";if(0==t.legitMoves.length)for(var a=1;a<=4;a++){if(1==a)r="up";else if(2==a)r="down";else if(3==a)r="right";else{if(4!=a){console.log("thinkTank():"+e+": has no where to move, finished"),boardFinished(e);continue}var r="left"}t[r].ranIntoStartBlock&&(n=r,$("#"+e+" .start").removeClass("on").addClass("off"))}else 1==t.legitMoves.length&&(n=t.legitMoves[0]);var i=doHolesNeedToBeFilled(e);if(i.boolean&&(n=i.fillHoleSide),"none"==n){for(var l=[],c=parseInt($("#"+e+" .active").attr("x")),d=parseInt($("#"+e+" .active").attr("y"));t.legitMoves.length>=1;){console.log("moveOptions"),console.log(t.legitMoves);var v=moveCordsOneBlock(r=t.legitMoves[0],c,d),f=traverseAllPathsIsPossible(e,o=parseInt(v.x),s=parseInt(v.y));if(0==f.boolean){p=f.openOn;if(console.log("openOn:"+p),"opposite"==p)var p=getOppositeDirections(r).opp;if(console.log("openOn:"+p),console.log("moveOptions"),console.log(t.legitMoves),console.log("openOnIndex:"+k),"null"!=p){console.log("checking openOn");v=moveCordsOneBlock(p,c,d);if(1==traverseAllPathsIsPossible(e,o=parseInt(v.x),s=parseInt(v.y)).boolean){console.log("openOn was true"),n=p;break}var k=t.legitMoves.indexOf(p);if(console.log("openOn was false"),-1!=k&&(console.log("splicing :"+r),t.legitMoves.splice(k,1),0==k))continue}}else l.push(r);console.log("Shifting:"+t.legitMoves[0]),t.legitMoves.shift()}console.log("traversableMovesArray"),console.log(l),"none"==n&&(n=closestMove(t,l))}moveToNext(e,n)}spliceFinishedBoards()}function thinkTankLoop(){0==thinkTankLoop_timer?(thinkTankLoop_timer=1,thinkTankLoop_timer=setInterval(function(){thinkTank()},CONSTANT_loopSpeed)):(clearInterval(thinkTankLoop_timer),thinkTankLoop_timer=0)}activeOpenBlockArray=[],boardsToSplice=[],thinkTankLoop_timer=0,activeBoards=[],CONSTANT_height=parseInt($(".easyVar.height").text()),CONSTANT_width=parseInt($(".easyVar.width").text()),CONSTANT_loopSpeed=parseInt($(".easyVar.speed").text()),CONSTANT_boardsToCreate=parseInt($(".easyVar.boards").text()),createBoard("alpha",CONSTANT_height,CONSTANT_width,10,9),$(document).on("click",".board",function(){$(this).hasClass("selected")?$(".board").removeClass("selected"):($(".board").removeClass("selected"),$(this).addClass("selected"))}),window.addEventListener("keydown",function(e){[32,37,38,39,40].indexOf(e.keyCode)>-1&&e.preventDefault()},!1),$("#new").on("click",function(){$(".board").remove(),activeBoards=[],activeOpenBlockArray=[],boardsToSplice=[];for(var e=0;e<CONSTANT_boardsToCreate;e++)createBoard("place"+e,CONSTANT_height,CONSTANT_width)}),$("#playButton").on("click",function(){thinkTankLoop()}),$("body").on("keyup",function(e){switch(e.keyCode){case 32:o="space";break;case 93:o="command";break;case 39:var o="right",s=$(".selected").attr("id");break;case 37:var o="left",s=$(".selected").attr("id");break;case 38:var o="up",s=$(".selected").attr("id");break;case 40:var o="down",s=$(".selected").attr("id");break;default:return}"command"!=o?"space"!=o?$(".selected").length&&moveToNext(s,o,1):thinkTankLoop():thinkTank()});
</script>	
</html>




