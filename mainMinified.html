<!DOCTYPE html>
<head>
	<title>Knights of the round square</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
</head>
<style type="text/css">
*{margin:0;padding:0;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}.board{float:left;padding:5px}.board.success{background-color:rgba(0,255,0,.2)}.board.failed{background-color:rgba(255,0,0,.2)}.board.selected{background-color:rgba(255,255,0,.2)}.board.selected.success{box-shadow:inset 0 0 3px 5px rgba(0,255,0,.5)}.board.selected.failed{box-shadow:inset 0 0 3px 5px rgba(255,0,0,.5)}.box{margin:3px;height:20px;width:20px;border:1px solid #000;float:left}.box.on{background-color:#00f}.box.beenHereAlready{background-color:red}.box.start{background-color:green}.box.traversedBlock{background-color:rgba(255,0,255,.4)}.box.active{border:4px solid orange}#new,#playButton{margin:10px;width:100%;max-width:200px;height:40px}
</style>
<body>
	<button id="new">new</button>
	<button id="playButton">start/stop</button>
</body>

<script type="text/javascript">
function boardFinished(e){$("#"+e+" .off:not(.start)").length||$("#"+e+" .beenHereAlready:not(.start)").length?(console.log("Failed! "+e+" was not completed!"),$("#"+e).addClass("failed")):(console.log("Success! "+e+" has been completed!"),$("#"+e).addClass("success")),activeBoards.indexOf(e)>-1&&boardsToSplice.push(e)}function spliceFinishedBoards(){for(var e=0;e<boardsToSplice.length;e++){var o=boardsToSplice[e],s=activeBoards.indexOf(o);s>-1&&activeBoards.splice(s,1)}}function createBoard(e,o,s,t,n){activeBoards[activeBoards.length]=e,$("body").append('<div class="board" size="'+s+"x"+o+'" id="'+e+'"></div>');for(var a=1,r=1;r<=o;){for(a=1;a<=s;)$("#"+e).append('<div id="'+e+"-"+a+"-"+r+'" class="box off" x="'+a+'" y="'+r+'"></div>'),a++;$("#"+e).append('<div style="clear:both;"></div>'),r++}chooseStart(e,o,s,t,n)}function chooseStart(e,o,s,t,n){if(void 0==t)var t=parseInt(Math.floor(Math.random()*s+1));if(void 0==n)var n=parseInt(Math.floor(Math.random()*o+1));$("#"+e+"-"+t+"-"+n).addClass("start active on").removeClass("off"),createActiveOpenBlockArray(e,t,n)}function createActiveOpenBlockArray(e,o,s){activeOpenBlockArray[e]=[];for(var t=0,n=0,a=1;a<=4;a++){if(1==a)t=o,n=s-1;else if(2==a)t=o,n=s+1;else if(3==a)t=o+1,n=s;else{if(4!=a)continue;t=o-1,n=s}doesBlockExist(e,t,n)&&activeOpenBlockArray[e].push(t+"-"+n)}}function moveToNext(e,o,s){1==s&&($("#"+e).hasClass("userTouched")||$("#"+e).addClass("userTouched"));var t=parseInt($("#"+e+" .active").attr("x")),n=parseInt($("#"+e+" .active").attr("y"));switch(o){case"up":n--;break;case"down":n++;break;case"right":t++;break;case"left":t--;break;default:console.log("moveToNext(): direction not recognized: "+o)}var a=t+"-"+n,r=activeOpenBlockArray[e].indexOf(a);-1!=r&&activeOpenBlockArray[e].splice(r,1),moveToThisElement="#"+e+"-"+t+"-"+n,doesBlockExist(e,t,n)?(blockHasClass("on",e,t,n)&&($(moveToThisElement).addClass("beenHereAlready"),boardFinished(e)),blockHasClass("start",e,t,n)&&boardFinished(e),$("#"+e+" .active").removeClass("active"),$(moveToThisElement).addClass("active on").removeClass("off")):1==s?console.log("You can't move there because that block doesn't exist."):(console.log("moveToNext(): asked to move to this element but it doesn't exist: "+moveToThisElement),boardFinished(e))}function doesBlockExist(e,o,s){return!!$("#"+e+"-"+o+"-"+s).length}function blockHasClass(e,o,s,t){return!!$("#"+o+"-"+s+"-"+t).hasClass(e)}function blockIsOpenAndExists(e,o,s,t){return doesBlockExist(e,o,s)&&blockHasClass("off",e,o,s)?(void 0!=t&&console.log("Block x:"+o+" y:"+s+" exists and is open"),!0):(void 0!=t&&console.log("Block x:"+o+" y:"+s+" does not exist and/or is not open"),!1)}function isNextToActiveBlock(e,o,s){for(var t=1;t<=4;t++){if(1==t)n="up";else if(2==t)n="down";else if(3==t)n="right";else{if(4!=t)continue;var n="left"}var a=moveCordsOneBlock(n,o,s),r=parseInt(a.x),i=parseInt(a.y);if(doesBlockExist(e,r,i)&&blockHasClass("active",e,r,i))return!0}return!1}function viewBlockMoveOptions(e,o,s,t){var a=[];a.legitMoves=[];for(var r=0;r<4;r++){switch(r){case 0:var i="up",l=s-1,c=o,d=-1;break;case 1:var i="down",l=s+1,c=o,d=1;break;case 2:i="right";l=s,c=o+1,d=1;break;case 3:i="left";l=s,c=o-1,d=-1}for(a[i]=[],a[i].moveableAmount=0,a[i].ranIntoStartBlock=!1,n=0,max=maxMoveRange(e);n<=max;){if(!blockIsOpenAndExists(e,c,l)&&!blockHasClass("traversedBlock",e,c,l)){blockHasClass("start",e,c,l)&&(a[i].ranIntoStartBlock=!0);break}a[i].moveableAmount++,0==r||1==r?l+=d:c+=d}a[i].moveableAmount>=1&&a.legitMoves.push(i)}return a}function moveCordsOneBlock(e,o,s){return"up"==e?s--:"down"==e?s++:"right"==e?o++:"left"==e?o--:console.log("moveCordsOneBlock() direction not recognized: "+e),{x:o,y:s}}function getOppositeDirections(e){if("up"==e)var o="down",s="right",t="left";else if("down"==e)var o="up",s="right",t="left";else if("right"==e)var o="left",s="up",t="down";else{if("left"!=e)return console.log("getOppositeDirections() direction not recognized: "+e),!1;var o="right",s="up",t="down"}return{opp:o,od1:s,od2:t}}function boardTotalBlocks(e){var o=$("#"+e).attr("size").split("x");return parseInt(o[0])*parseInt(o[1])}function maxMoveRange(e){var o=$("#"+e).attr("size").split("x"),s=parseInt(o[0]),t=parseInt(o[1]);return s>t?s:t}function percentageOfTheBoardTraversed(e){var o=boardTotalBlocks(e);return $("#"+e+" .on").length/o}function closestMove(e,o){bestMove="none";for(var s=1;s<=4;s++){if(1==s)t="up";else if(2==s)t="down";else if(3==s)t="right";else{if(4!=s)continue;var t="left"}0!=e[t].moveableAmount&&(void 0!=o&&-1==o.indexOf(t)||("none"==bestMove||e[t].moveableAmount<e[bestMove].moveableAmount)&&(bestMove=t))}return bestMove}function traverseAllPathsIsPossible(e,o,s){var t=!1,n="null";if(activeOpenBlockArray[e].length>=2&&!$("#"+e).hasClass("userTouched"))return t=!0,{boolean:t,openOn:n};if(!activeOpenBlockArray[e][0])return boardFinished(e),{boolean:t,openOn:n};activeOpenBlockArray[e][0];var a=activeOpenBlockArray[e][0].split("-"),r=parseInt(a[0]),i=parseInt(a[1]);if(o==r&&s==i)return n="opposite",{boolean:t,openOn:n};var l=$("#"+e+" .off").length;$("#"+e+"-"+o+"-"+s).addClass("traversedBlock"),$("#"+e+"-"+r+"-"+i).addClass("traversedBlock");for(var c=[{x:r,y:i}];c.length>=1;){for(var d=viewBlockMoveOptions(e,r=c[0].x,i=c[0].y),v=1;v<=4;v++){if(1==v)u="up";else if(2==v)u="down";else if(3==v)u="right";else{if(4!=v)continue;u="left"}if(0!=d[u].moveableAmount){var f=moveCordsOneBlock(u,r,i),p=f.x,k=f.y;blockHasClass("traversedBlock",e,p,k)||blockHasClass("on",e,p,k)||($("#"+e+"-"+p+"-"+k).addClass("traversedBlock"),c.push(f))}}c.shift()}if(l==$("#"+e+" .traversedBlock").length)t=!0;else for(var h=1;h<=4;h++){if(1==h)u="up";else if(2==h)u="down";else if(3==h)u="right";else{if(4!=h)continue;var u="left"}var b=moveCordsOneBlock(u,o,s),x=parseInt(b.x),g=parseInt(b.y);if(blockIsOpenAndExists(e,x,g)&&!blockHasClass("traversedBlock",e,x,g)){for(var O=1;O<=4;O++){if(1==O)T="up";else if(2==O)T="down";else if(3==O)T="right";else{if(4!=O)continue;var T="left"}var B=moveCordsOneBlock(T,x,g),m=parseInt(B.x),C=parseInt(B.y);if(blockIsOpenAndExists(e,m,C)&&!blockHasClass("traversedBlock",e,m,C)&&isNextToActiveBlock(e,m,C))break}var A=C-1,y=C+1,I=m+1,w=m-1;if(blockIsOpenAndExists(e,m,A)&&blockIsOpenAndExists(e,m,y)&&!blockIsOpenAndExists(e,I,C)&&!blockIsOpenAndExists(e,w,C))continue;if(blockIsOpenAndExists(e,I,C)&&blockIsOpenAndExists(e,w,C)&&!blockIsOpenAndExists(e,m,A)&&!blockIsOpenAndExists(e,m,y))continue;n=u;break}}return $("#"+e+" .traversedBlock").removeClass("traversedBlock"),{boolean:t,openOn:n}}function doHolesNeedToBeFilled(e){for(var o=parseInt($("#"+e+" .active").attr("x")),s=parseInt($("#"+e+" .active").attr("y")),t=1;t<=4;t++){if(1==t)n="up";else if(2==t)n="down";else if(3==t)n="right";else{if(4!=t)continue;var n="left"}var a=moveCordsOneBlock(n,o,s),r=parseInt(a.x),i=parseInt(a.y);if(blockIsOpenAndExists(e,r,i)){for(var l=0,c=1;c<=4;c++){if(1==c)d="up";else if(2==c)d="down";else if(3==c)d="right";else{if(4!=c)continue;var d="left"}var v=(a=moveCordsOneBlock(d,r,i)).x,f=a.y;(blockIsOpenAndExists(e,v,f)||blockHasClass("start",e,v,f))&&l++}if(1==l)return{boolean:!0,fillHoleSide:n}}}return{boolean:!1}}function willThisBlockCreateA2x2Trap(e,o,s){var t=viewBlockMoveOptions(e,o,s,1);e:for(var n=0;n<t.legitMoves.length;n++){var a=[],r=t.legitMoves[n],i=getOppositeDirections(r),l=moveCordsOneBlock(r,o,s),c=l.x,d=l.y,v=viewBlockMoveOptions(e,c,d,1);if(a.center1={x:c,y:d},-1!=v.legitMoves.indexOf(r)&&(-1!=v.legitMoves.indexOf(i.od1)||-1!=v.legitMoves.indexOf(i.od2))){for(var f=1;f<=4;f++){if(1==f)p="up";else if(2==f)p="down";else if(3==f)p="right";else{if(4!=f)continue;var p="left"}if(i.opp!=p){var k=moveCordsOneBlock(p,c,d),h=k.x,u=k.y;if(p==r){if(!blockIsOpenAndExists(e,h,u))break e;a.center2={x:h,y:u}}else{var b=moveCordsOneBlock(r,h,u),x=b.x,g=b.y;if(blockIsOpenAndExists(e,h,u)&&blockIsOpenAndExists(e,x,g)){void 0==a.side1?(a.side1={x:h,y:u},a.side2={x:x,y:g}):(a.third1={x:h,y:u},a.third2={x:x,y:g});continue}}}}if(void 0==a.center1||void 0==a.center2||void 0==a.side1||void 0==a.side2||void 0!=a.third1&&void 0!=a.third2)console.log("firstMove cannot create a trap: "+r),console.log(a),console.log("twoByTwoArea.length"),console.log(a.length);else for(var O=[],T=0,B=1;B<=4;B++){if(1==B)m="center1";else if(2==B)m="center2";else if(3==B)m="side1";else{if(4!=B)continue;var m="side2"}O[m]="closed";for(var C=1;C<=4;C++){if(1==C)A="up";else if(2==C)A="down";else if(3==C)A="right";else{if(4!=C)continue;var A="left"}var y=moveCordsOneBlock(A,a[m].x,a[m].y),I=y.x,$=y.y;if(!(I==a.center1.x&&$==a.center1.y||I==a.center2.x&&$==a.center2.y||I==a.side1.x&&$==a.side1.y||I==a.side2.x&&$==a.side2.y)&&(doesBlockExist(e,I,$)&&(I!=o||$!=s)&&(blockHasClass("start",e,I,$)||blockHasClass("off",e,I,$)))){O[m]="open",T++;break}}if(console.log("openSides"),console.log(O),console.log("openSidesCount:"+T),1!=T&&("open"==O.center1&&"closed"==O.center2&&"closed"==O.side1||"open"==O.center2&&"closed"==O.center1&&"closed"==O.side2||"open"==O.side1&&"closed"==O.center1&&"closed"==O.side2||"open"==O.side2&&"closed"==O.center2&&"closed"==O.side1))return console.log("openSidesCount:"+T),console.log("willThisBlockCreateA2x2Trap: true move:"+r),{boolean:!0}}}}return{boolean:!1}}function thinkTank(){if(0==activeBoards.length)return clearInterval(thinkTankLoop_timer),void(thinkTankLoop_timer=0);for(i=0;i<activeBoards.length;i++){var e=activeBoards[i],o=parseInt($("#"+e+" .active").attr("x")),s=parseInt($("#"+e+" .active").attr("y")),t=viewBlockMoveOptions(e,o,s),n="none";if(0==t.legitMoves.length)for(i=1;i<=4;i++){if(1==i)a="up";else if(2==i)a="down";else if(3==i)a="right";else{if(4!=i){console.log("thinkTank():"+e+": has no where to move, finished"),boardFinished(e);continue}var a="left"}t[a].ranIntoStartBlock&&(n=a,$("#"+e+" .start").removeClass("on").addClass("off"))}else 1==t.legitMoves.length&&(n=t.legitMoves[0]);var r=doHolesNeedToBeFilled(e);if(r.boolean&&(n=r.fillHoleSide),"none"==n&&(CONSTANT_height>=12&&CONSTANT_width>=12||$("#"+e).hasClass("userTouched")))for(var i=0;i<t.legitMoves.length;i++){var l=t.legitMoves[i];if(1==willThisBlockCreateA2x2Trap(e,(p=moveCordsOneBlock(l,o,s)).x,p.y).boolean){var c=t.legitMoves.indexOf(l);-1!=c&&(t.legitMoves.splice(c,1),i-=1)}}if("none"==n){for(var d=[],v=parseInt($("#"+e+" .active").attr("x")),f=parseInt($("#"+e+" .active").attr("y"));t.legitMoves.length>=1;){var p=moveCordsOneBlock(a=t.legitMoves[0],v,f),k=traverseAllPathsIsPossible(e,o=parseInt(p.x),s=parseInt(p.y));if(0==k.boolean){if("opposite"==(h=k.openOn))var h=getOppositeDirections(a).opp;if("null"!=h){p=moveCordsOneBlock(h,v,f);if(1==traverseAllPathsIsPossible(e,o=parseInt(p.x),s=parseInt(p.y)).boolean){n=h;break}var u=t.legitMoves.indexOf(h);if(-1!=u&&(t.legitMoves.splice(u,1),0==u))continue}}else d.push(a);t.legitMoves.shift()}"none"==n&&(n=closestMove(t,d))}moveToNext(e,n)}spliceFinishedBoards()}function thinkTankLoop(){0==thinkTankLoop_timer?(thinkTankLoop_timer=1,thinkTankLoop_timer=setInterval(function(){thinkTank()},CONSTANT_loopSpeed)):(clearInterval(thinkTankLoop_timer),thinkTankLoop_timer=0)}activeOpenBlockArray=[],boardsToSplice=[],thinkTankLoop_timer=0,activeBoards=[],CONSTANT_height=parseInt($(".easyVar.height").text()),CONSTANT_width=parseInt($(".easyVar.width").text()),CONSTANT_loopSpeed=parseInt($(".easyVar.speed").text()),CONSTANT_boardsToCreate=parseInt($(".easyVar.boards").text());for(var i=0;i<CONSTANT_boardsToCreate;i++){var foo="place"+i;createBoard(foo,CONSTANT_height,CONSTANT_width)}$(document).on("click",".board",function(){$(this).hasClass("selected")?$(".board").removeClass("selected"):($(".board").removeClass("selected"),$(this).addClass("selected"))}),window.addEventListener("keydown",function(e){[32,37,38,39,40].indexOf(e.keyCode)>-1&&e.preventDefault()},!1),$("#new").on("click",function(){$(".board").remove(),activeBoards=[],activeOpenBlockArray=[],boardsToSplice=[];for(var e=0;e<CONSTANT_boardsToCreate;e++)createBoard("place"+e,CONSTANT_height,CONSTANT_width)}),$("#playButton").on("click",function(){thinkTankLoop()}),$("body").on("keyup",function(e){switch(e.keyCode){case 32:o="space";break;case 93:o="command";break;case 39:var o="right",s=$(".selected").attr("id");break;case 37:var o="left",s=$(".selected").attr("id");break;case 38:var o="up",s=$(".selected").attr("id");break;case 40:var o="down",s=$(".selected").attr("id");break;default:return}"command"!=o?"space"!=o?$(".selected").length&&moveToNext(s,o,1):thinkTankLoop():thinkTank()});
</script>	
</html>




