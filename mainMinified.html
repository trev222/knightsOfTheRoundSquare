<!DOCTYPE html>
<head>
	<title>Knights of the round square</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
</head>
<style type="text/css">
*{margin:0;padding:0;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}.board{float:left;padding:5px}.board.success{background-color:rgba(0,255,0,.2)}.board.failed{background-color:rgba(255,0,0,.2)}.board.selected{background-color:rgba(255,255,0,.2)}.board.selected.success{box-shadow:inset 0 0 3px 5px rgba(0,255,0,.5)}.board.selected.failed{box-shadow:inset 0 0 3px 5px rgba(255,0,0,.5)}.box{margin:3px;height:20px;width:20px;border:1px solid #000;float:left}.box.on{background-color:#00f}.box.beenHereAlready{background-color:red}.box.start{background-color:green}.box.traversedBlock{background-color:rgba(255,0,255,.4)}.box.active{border:4px solid orange}#new,#playButton{margin:10px;width:100%;max-width:200px;height:40px}
</style>
<body>
	<button id="new">new</button>
	<button id="playButton">start/stop</button>
</body>

<script type="text/javascript">
function boardFinished(e){$("#"+e+" .off:not(.start)").length||$("#"+e+" .beenHereAlready:not(.start)").length?(console.log("Failed! "+e+" was not completed!"),$("#"+e).addClass("failed")):(console.log("Success! "+e+" has been completed!"),$("#"+e).addClass("success")),activeBoards.indexOf(e)>-1&&boardsToSplice.push(e)}function spliceFinishedBoards(){for(var e=0;e<boardsToSplice.length;e++){var o=boardsToSplice[e],t=activeBoards.indexOf(o);t>-1&&activeBoards.splice(t,1)}}function createBoard(e,o,t,s,a){activeBoards[activeBoards.length]=e,$("body").append('<div class="board" size="'+t+"x"+o+'" id="'+e+'"></div>');for(var n=1,r=1;r<=o;){for(n=1;n<=t;)$("#"+e).append('<div id="'+e+"-"+n+"-"+r+'" class="box off" x="'+n+'" y="'+r+'"></div>'),n++;$("#"+e).append('<div style="clear:both;"></div>'),r++}chooseStart(e,o,t,s,a)}function chooseStart(e,o,t,s,a){if(void 0==s)var s=parseInt(Math.floor(Math.random()*t+1));if(void 0==a)var a=parseInt(Math.floor(Math.random()*o+1));$("#"+e+"-"+s+"-"+a).addClass("start active on").removeClass("off"),createActiveOpenBlockArray(e,s,a)}function createActiveOpenBlockArray(e,o,t){activeOpenBlockArray[e]=[];var s=t-1;$("#"+e+"-"+o+"-"+s).length&&activeOpenBlockArray[e].push(o+"-"+s);var a=t+1;$("#"+e+"-"+o+"-"+a).length&&activeOpenBlockArray[e].push(o+"-"+a);var n=o+1;$("#"+e+"-"+n+"-"+t).length&&activeOpenBlockArray[e].push(n+"-"+t);var r=o-1;$("#"+e+"-"+r+"-"+t).length&&activeOpenBlockArray[e].push(r+"-"+t)}function moveToNext(e,o){var t=$("#"+e+" .active").attr("x"),s=$("#"+e+" .active").attr("y");switch(o){case"up":s--;break;case"down":s++;break;case"right":t++;break;case"left":t--;break;default:console.log("moveToNext(): direction not recognized: "+o)}var a=t+"-"+s,n=activeOpenBlockArray[e].indexOf(a);if(-1!=n&&activeOpenBlockArray[e].splice(n,1),moveToThisElement="#"+e+"-"+t+"-"+s,!$(moveToThisElement).length)return console.log("moveToNext(): asked to move to this element but it doesn't exist: "+moveToThisElement),void boardFinished(e);$(moveToThisElement).hasClass("on")&&($(moveToThisElement).addClass("beenHereAlready"),boardFinished(e)),$(moveToThisElement).hasClass("start")&&boardFinished(e),$("#"+e+" .active").removeClass("active"),$(moveToThisElement).addClass("active on").removeClass("off")}function doesBlockExist(e,o,t){return!!$("#"+e+"-"+o+"-"+t).length}function blockHasClass(e,o,t,s){return!!$("#"+o+"-"+t+"-"+s).hasClass(e)}function blockIsOpenAndExists(e,o,t,s){return doesBlockExist(e,o,t)&&blockHasClass("off",e,o,t)?(void 0!=s&&console.log("Block x:"+o+" y:"+t+" exists and is open"),!0):(void 0!=s&&console.log("Block x:"+o+" y:"+t+" does not exist and/or is not open"),!1)}function isNextToActiveBlock(e,o,t){for(var s=1;s<=4;s++){if(1==s)a="up";else if(2==s)a="down";else if(3==s)a="right";else{if(4!=s)continue;var a="left"}var n=moveCordsOneBlock(a,o,t),r=parseInt(n.x),i=parseInt(n.y);if(doesBlockExist(e,r,i)&&blockHasClass("active",e,r,i))return!0}return!1}function viewBlockMoveOptions(e,o,t){var s=[];s.legitMoves=[];for(var a=0;a<4;a++){switch(a){case 0:var r="up",i=t,l=-1;break;case 1:var r="down",i=t,l=1;break;case 2:r="right";i=o,l=1;break;case 3:r="left";i=o,l=-1}s[r]=[],s[r].moveableAmount=0,s[r].ranIntoStartBlock=!1;var c=i+l;for(n=0,max=maxMoveRange(e);n<=max;){if(0==a||1==a){if(!blockIsOpenAndExists(e,o,c)&&!blockHasClass("traversedBlock",e,o,c)){blockHasClass("start",e,o,c)&&(s[r].ranIntoStartBlock=!0);break}}else if(!blockIsOpenAndExists(e,c,t)&&!blockHasClass("traversedBlock",e,c,o)){blockHasClass("start",e,c,t)&&(s[r].ranIntoStartBlock=!0);break}s[r].moveableAmount++,c+=l}s[r].moveableAmount>=1&&s.legitMoves.push(r)}return s}function moveCordsOneBlock(e,o,t){return"up"==e?t--:"down"==e?t++:"right"==e?o++:"left"==e?o--:console.log("moveCordsDirection() direction not recognized: "+e),{x:o,y:t}}function getOppositeDirections(e){if("up"==e)var o="down",t="right",s="left";else if("down"==e)var o="up",t="right",s="left";else if("right"==e)var o="left",t="up",s="down";else{if("left"!=e)return console.log("getOppositeDirections() direction not recognized: "+e),!1;var o="right",t="up",s="down"}return{opp:o,od1:t,od2:s}}function boardTotalBlocks(e){var o=$("#"+e).attr("size").split("x");return parseInt(o[0])*parseInt(o[1])}function maxMoveRange(e){var o=$("#"+e).attr("size").split("x"),t=parseInt(o[0]),s=parseInt(o[1]);return t>s?t:s}function percentageOfTheBoardTraversed(e){var o=boardTotalBlocks(e);return $("#"+e+" .on").length/o}function closestMove(e,o){bestMove="none";for(var t=1;t<=4;t++){if(1==t)s="up";else if(2==t)s="down";else if(3==t)s="right";else{if(4!=t)continue;var s="left"}0!=e[s].moveableAmount&&(void 0!=o&&-1==o.indexOf(s)||("none"==bestMove||e[s].moveableAmount<e[bestMove].moveableAmount)&&(bestMove=s))}return bestMove}function isThisMoveOpenOnBothSides(e,o,t,s){var a=moveCordsOneBlock(o,t,s),n=getOppositeDirections(o),r=moveCordsOneBlock(n.od1,a.x,a.y),i=moveCordsOneBlock(n.od2,a.x,a.y);return!(!blockIsOpenAndExists(e,r.x,r.y)||!blockIsOpenAndExists(e,i.x,i.y))}function startBlockIsTouchingATraverseBlockButNotThisBlock(e,o,t){for(var s=parseInt($("#"+e+" .start").attr("x")),a=parseInt($("#"+e+" .start").attr("y")),n=1;n<4;n++){if(1==n)r="up";else if(2==n)r="down";else if(3==n)r="right";else{if(4!=n)continue;var r="left"}var i=moveCordsOneBlock(r,s,a),l=parseInt(i.x),c=parseInt(i.y);if(doesBlockExist(e,l,c)&&blockHasClass("traversedBlock",e,l,c)&&l==o&&c==t)return!0}return!1}function traverseAllPathsIsPossible(e,o,t){var s=!1,a="null";if(activeOpenBlockArray[e].length>=2)return s=!0,{boolean:s,openOn:a};if(!activeOpenBlockArray[e][0])return boardFinished(e),{boolean:s,openOn:a};activeOpenBlockArray[e][0];var n=activeOpenBlockArray[e][0].split("-"),r=parseInt(n[0]),i=parseInt(n[1]);if(o==r&&t==i)return a="opposite",{boolean:s,openOn:a};var l=$("#"+e+" .off").length;$("#"+e+"-"+o+"-"+t).addClass("traversedBlock"),$("#"+e+"-"+r+"-"+i).addClass("traversedBlock");for(var c=[{x:r,y:i}];c.length>=1;){for(var d=viewBlockMoveOptions(e,r=c[0].x,i=c[0].y),v=1;v<=4;v++){if(1==v)u="up";else if(2==v)u="down";else if(3==v)u="right";else{if(4!=v)continue;u="left"}if(0!=d[u].moveableAmount){var f=moveCordsOneBlock(u,r,i),p=f.x,k=f.y;blockHasClass("traversedBlock",e,p,k)||blockHasClass("on",e,p,k)||($("#"+e+"-"+p+"-"+k).addClass("traversedBlock"),c.push(f))}}c.shift()}if(l==$("#"+e+" .traversedBlock").length)s=!0;else for(var h=1;h<=4;h++){if(1==h)u="up";else if(2==h)u="down";else if(3==h)u="right";else{if(4!=h)continue;var u="left"}var b=moveCordsOneBlock(u,o,t),B=parseInt(b.x),m=parseInt(b.y);if(blockIsOpenAndExists(e,B,m)&&!blockHasClass("traversedBlock",e,B,m)){for(var g=1;g<=4;g++){if(1==g)x="up";else if(2==g)x="down";else if(3==g)x="right";else{if(4!=g)continue;var x="left"}var O=moveCordsOneBlock(x,B,m),I=parseInt(O.x),T=parseInt(O.y);if(blockIsOpenAndExists(e,I,T)&&!blockHasClass("traversedBlock",e,I,T)&&isNextToActiveBlock(e,I,T))break}var C=T-1,y=T+1,A=I+1,w=I-1;if(blockIsOpenAndExists(e,I,C)&&blockIsOpenAndExists(e,I,y)&&!blockIsOpenAndExists(e,A,T)&&!blockIsOpenAndExists(e,w,T))continue;if(blockIsOpenAndExists(e,A,T)&&blockIsOpenAndExists(e,w,T)&&!blockIsOpenAndExists(e,I,C)&&!blockIsOpenAndExists(e,I,y))continue;a=u;break}}return $("#"+e+" .traversedBlock").removeClass("traversedBlock"),{boolean:s,openOn:a}}function doHolesNeedToBeFilled(e){for(var o=parseInt($("#"+e+" .active").attr("x")),t=parseInt($("#"+e+" .active").attr("y")),s=1;s<=4;s++){if(1==s)a="up";else if(2==s)a="down";else if(3==s)a="right";else{if(4!=s)continue;var a="left"}var n=moveCordsOneBlock(a,o,t),r=n.x,i=n.y;if(blockIsOpenAndExists(e,r,i)){for(var l=0,c=1;c<=4;c++){if(1==c)d="up";else if(2==c)d="down";else if(3==c)d="right";else{if(4!=c)continue;var d="left"}var v=(n=moveCordsOneBlock(d,r,i)).x,f=n.y;(blockIsOpenAndExists(e,v,f)||doesBlockExist(e,v,f)&&blockHasClass("start",e,v,f))&&l++}if(1==l)return{boolean:!0,fillHoleSide:a}}}return{boolean:!1}}function thinkTank(){if(0==activeBoards.length)return clearInterval(thinkTankLoop_timer),void(thinkTankLoop_timer=0);for(d=0;d<activeBoards.length;d++){var e=activeBoards[d],o=parseInt($("#"+e+" .active").attr("x")),t=parseInt($("#"+e+" .active").attr("y")),s=viewBlockMoveOptions(e,o,t),a="none";if(0==s.legitMoves.length)for(d=1;d<=4;d++){if(1==d)n="up";else if(2==d)n="down";else if(3==d)n="right";else{if(4!=d){console.log("thinkTank():"+e+": has no where to move, finished"),boardFinished(e);continue}var n="left"}s[n].ranIntoStartBlock&&(a=n,$("#"+e+" .start").removeClass("on").addClass("off"))}else 1==s.legitMoves.length&&(a=s.legitMoves[0]);var r=doHolesNeedToBeFilled(e);if(r.boolean&&(a=r.fillHoleSide),"none"==a){for(var i=[],l=parseInt($("#"+e+" .active").attr("x")),c=parseInt($("#"+e+" .active").attr("y")),d=0;d<s.legitMoves.length;d++){var v=moveCordsOneBlock(n=s.legitMoves[d],l,c),f=traverseAllPathsIsPossible(e,o=parseInt(v.x),t=parseInt(v.y));if(0==f.boolean){if("opposite"==(p=f.openOn))var p=getOppositeDirections(n).opp;if(-1!=s.legitMoves.indexOf(p)){a=p;break}}else i.push(n)}"none"==a&&(a=closestMove(s,i))}moveToNext(e,a)}spliceFinishedBoards()}function thinkTankLoop(){0==thinkTankLoop_timer?(thinkTankLoop_timer=1,thinkTankLoop_timer=setInterval(function(){thinkTank()},200)):(clearInterval(thinkTankLoop_timer),thinkTankLoop_timer=0)}activeOpenBlockArray=[],boardsToSplice=[],thinkTankLoop_timer=0,activeBoards=[];for(var height=8,width=8,i=0;i<1;i++){var foo="place"+i;createBoard(foo,height,width)}$(document).on("click",".board",function(){$(this).hasClass("selected")?$(".board").removeClass("selected"):($(".board").removeClass("selected"),$(this).addClass("selected"))}),window.addEventListener("keydown",function(e){[32,37,38,39,40].indexOf(e.keyCode)>-1&&e.preventDefault()},!1),$("#new").on("click",function(){$(".board").remove(),activeBoards=[],activeOpenBlockArray=[],boardsToSplice=[],createBoard(foo,height,width)}),$("#playButton").on("click",function(){thinkTankLoop()}),$("body").on("keyup",function(e){switch(e.keyCode){case 32:o="space";break;case 93:o="command";break;case 39:var o="right",t=$(".selected").attr("id");break;case 37:var o="left",t=$(".selected").attr("id");break;case 38:var o="up",t=$(".selected").attr("id");break;case 40:var o="down",t=$(".selected").attr("id");break;default:return}"command"!=o?"space"!=o?$(".selected").length&&moveToNext(t,o):thinkTankLoop():thinkTank()});
</script>	
</html>




