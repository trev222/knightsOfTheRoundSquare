<!DOCTYPE html>
<head>
	<title>Knights of the round square</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
</head>
<style type="text/css">
*{margin:0;padding:0;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}.board{float:left;padding:5px}.board.success{background-color:rgba(0,255,0,.2)}.board.failed{background-color:rgba(255,0,0,.2)}.board.selected{background-color:rgba(255,255,0,.2)}.board.selected.success{box-shadow:inset 0 0 3px 5px rgba(0,255,0,.5)}.board.selected.failed{box-shadow:inset 0 0 3px 5px rgba(255,0,0,.5)}.box{margin:3px;height:20px;width:20px;border:1px solid #000;float:left}.box.on{background-color:#00f}.box.beenHereAlready{background-color:red}.box.start{background-color:green}.box.traversedBlock{background-color:rgba(255,0,255,.4)}.box.active{border:4px solid orange}#new,#playButton{margin:10px;width:100%;max-width:200px;height:40px}
</style>
<body>
	<button id="new">new</button>
	<button id="playButton">start/stop</button>
</body>

<script type="text/javascript">
function boardFinished(e){$("#"+e+" .off:not(.start)").length||$("#"+e+" .beenHereAlready:not(.start)").length?(console.log("Failed! "+e+" was not completed!"),$("#"+e).addClass("failed")):(console.log("Success! "+e+" has been completed!"),$("#"+e).addClass("success")),activeBoards.indexOf(e)>-1&&boardsToSplice.push(e)}function spliceFinishedBoards(){for(var e=0;e<boardsToSplice.length;e++){var o=boardsToSplice[e],t=activeBoards.indexOf(o);t>-1&&activeBoards.splice(t,1)}}function createBoard(e,o,t,s,a){activeBoards[activeBoards.length]=e,$("body").append('<div class="board" size="'+t+"x"+o+'" id="'+e+'"></div>');for(var n=1,r=1;r<=o;){for(n=1;n<=t;)$("#"+e).append('<div id="'+e+"-"+n+"-"+r+'" class="box off" x="'+n+'" y="'+r+'"></div>'),n++;$("#"+e).append('<div style="clear:both;"></div>'),r++}chooseStart(e,o,t,s,a)}function chooseStart(e,o,t,s,a){if(void 0==s)var s=parseInt(Math.floor(Math.random()*t+1));if(void 0==a)var a=parseInt(Math.floor(Math.random()*o+1));$("#"+e+"-"+s+"-"+a).addClass("start active on").removeClass("off"),createActiveOpenBlockArray(e,s,a)}function createActiveOpenBlockArray(e,o,t){activeOpenBlockArray[e]=[];for(var s=0,a=0,n=1;n<=4;n++){if(1==n)s=o,a=t-1;else if(2==n)s=o,a=t+1;else if(3==n)s=o+1,a=t;else{if(4!=n)continue;s=o-1,a=t}doesBlockExist(e,s,a)&&activeOpenBlockArray[e].push(s+"-"+a)}}function moveToNext(e,o,t){1==t&&($("#"+e).hasClass("userTouched")||$("#"+e).addClass("userTouched"));var s=parseInt($("#"+e+" .active").attr("x")),a=parseInt($("#"+e+" .active").attr("y"));switch(o){case"up":a--;break;case"down":a++;break;case"right":s++;break;case"left":s--;break;default:console.log("moveToNext(): direction not recognized: "+o)}var n=s+"-"+a,r=activeOpenBlockArray[e].indexOf(n);-1!=r&&activeOpenBlockArray[e].splice(r,1),moveToThisElement="#"+e+"-"+s+"-"+a,doesBlockExist(e,s,a)?(blockHasClass("on",e,s,a)&&($(moveToThisElement).addClass("beenHereAlready"),boardFinished(e)),blockHasClass("start",e,s,a)&&boardFinished(e),$("#"+e+" .active").removeClass("active"),$(moveToThisElement).addClass("active on").removeClass("off")):1==t?console.log("You can't move there because that block doesn't exist."):(console.log("moveToNext(): asked to move to this element but it doesn't exist: "+moveToThisElement),boardFinished(e))}function doesBlockExist(e,o,t){return!!$("#"+e+"-"+o+"-"+t).length}function blockHasClass(e,o,t,s){return!!$("#"+o+"-"+t+"-"+s).hasClass(e)}function blockIsOpenAndExists(e,o,t,s){return doesBlockExist(e,o,t)&&blockHasClass("off",e,o,t)?(void 0!=s&&console.log("Block x:"+o+" y:"+t+" exists and is open"),!0):(void 0!=s&&console.log("Block x:"+o+" y:"+t+" does not exist and/or is not open"),!1)}function isNextToActiveBlock(e,o,t){for(var s=1;s<=4;s++){if(1==s)a="up";else if(2==s)a="down";else if(3==s)a="right";else{if(4!=s)continue;var a="left"}var n=moveCordsOneBlock(a,o,t),r=parseInt(n.x),i=parseInt(n.y);if(doesBlockExist(e,r,i)&&blockHasClass("active",e,r,i))return!0}return!1}function viewBlockMoveOptions(e,o,t){var s=[];s.legitMoves=[];for(var a=0;a<4;a++){switch(a){case 0:var r="up",i=t-1,l=o,c=-1;break;case 1:var r="down",i=t+1,l=o,c=1;break;case 2:r="right";i=t,l=o+1,c=1;break;case 3:r="left";i=t,l=o-1,c=-1}for(s[r]=[],s[r].moveableAmount=0,s[r].ranIntoStartBlock=!1,n=0,max=maxMoveRange(e);n<=max;){if(!blockIsOpenAndExists(e,l,i)&&!blockHasClass("traversedBlock",e,l,i)){blockHasClass("start",e,l,i)&&(s[r].ranIntoStartBlock=!0);break}s[r].moveableAmount++,0==a||1==a?i+=c:l+=c}s[r].moveableAmount>=1&&s.legitMoves.push(r)}return s}function moveCordsOneBlock(e,o,t){return"up"==e?t--:"down"==e?t++:"right"==e?o++:"left"==e?o--:console.log("moveCordsDirection() direction not recognized: "+e),{x:o,y:t}}function getOppositeDirections(e){if("up"==e)var o="down",t="right",s="left";else if("down"==e)var o="up",t="right",s="left";else if("right"==e)var o="left",t="up",s="down";else{if("left"!=e)return console.log("getOppositeDirections() direction not recognized: "+e),!1;var o="right",t="up",s="down"}return{opp:o,od1:t,od2:s}}function boardTotalBlocks(e){var o=$("#"+e).attr("size").split("x");return parseInt(o[0])*parseInt(o[1])}function maxMoveRange(e){var o=$("#"+e).attr("size").split("x"),t=parseInt(o[0]),s=parseInt(o[1]);return t>s?t:s}function percentageOfTheBoardTraversed(e){var o=boardTotalBlocks(e);return $("#"+e+" .on").length/o}function closestMove(e,o){bestMove="none";for(var t=1;t<=4;t++){if(1==t)s="up";else if(2==t)s="down";else if(3==t)s="right";else{if(4!=t)continue;var s="left"}0!=e[s].moveableAmount&&(void 0!=o&&-1==o.indexOf(s)||("none"==bestMove||e[s].moveableAmount<e[bestMove].moveableAmount)&&(bestMove=s))}return bestMove}function traverseAllPathsIsPossible(e,o,t){var s=!1,a="null";if(activeOpenBlockArray[e].length>=2&&!$("#"+e).hasClass("userTouched"))return s=!0,{boolean:s,openOn:a};if(!activeOpenBlockArray[e][0])return boardFinished(e),{boolean:s,openOn:a};activeOpenBlockArray[e][0];var n=activeOpenBlockArray[e][0].split("-"),r=parseInt(n[0]),i=parseInt(n[1]);if(o==r&&t==i)return a="opposite",{boolean:s,openOn:a};var l=$("#"+e+" .off").length;$("#"+e+"-"+o+"-"+t).addClass("traversedBlock"),$("#"+e+"-"+r+"-"+i).addClass("traversedBlock");for(var c=[{x:r,y:i}];c.length>=1;){for(var d=viewBlockMoveOptions(e,r=c[0].x,i=c[0].y),v=1;v<=4;v++){if(1==v)u="up";else if(2==v)u="down";else if(3==v)u="right";else{if(4!=v)continue;u="left"}if(0!=d[u].moveableAmount){var f=moveCordsOneBlock(u,r,i),p=f.x,k=f.y;blockHasClass("traversedBlock",e,p,k)||blockHasClass("on",e,p,k)||($("#"+e+"-"+p+"-"+k).addClass("traversedBlock"),c.push(f))}}c.shift()}if(l==$("#"+e+" .traversedBlock").length)s=!0;else for(var h=1;h<=4;h++){if(1==h)u="up";else if(2==h)u="down";else if(3==h)u="right";else{if(4!=h)continue;var u="left"}var b=moveCordsOneBlock(u,o,t),m=parseInt(b.x),T=parseInt(b.y);if(blockIsOpenAndExists(e,m,T)&&!blockHasClass("traversedBlock",e,m,T)){for(var B=1;B<=4;B++){if(1==B)x="up";else if(2==B)x="down";else if(3==B)x="right";else{if(4!=B)continue;var x="left"}var g=moveCordsOneBlock(x,m,T),O=parseInt(g.x),C=parseInt(g.y);if(blockIsOpenAndExists(e,O,C)&&!blockHasClass("traversedBlock",e,O,C)&&isNextToActiveBlock(e,O,C))break}var I=C-1,A=C+1,y=O+1,w=O-1;if(blockIsOpenAndExists(e,O,I)&&blockIsOpenAndExists(e,O,A)&&!blockIsOpenAndExists(e,y,C)&&!blockIsOpenAndExists(e,w,C))continue;if(blockIsOpenAndExists(e,y,C)&&blockIsOpenAndExists(e,w,C)&&!blockIsOpenAndExists(e,O,I)&&!blockIsOpenAndExists(e,O,A))continue;a=u;break}}return $("#"+e+" .traversedBlock").removeClass("traversedBlock"),{boolean:s,openOn:a}}function doHolesNeedToBeFilled(e){for(var o=parseInt($("#"+e+" .active").attr("x")),t=parseInt($("#"+e+" .active").attr("y")),s=1;s<=4;s++){if(1==s)a="up";else if(2==s)a="down";else if(3==s)a="right";else{if(4!=s)continue;var a="left"}var n=moveCordsOneBlock(a,o,t),r=parseInt(n.x),i=parseInt(n.y);if(blockIsOpenAndExists(e,r,i)){for(var l=0,c=1;c<=4;c++){if(1==c)d="up";else if(2==c)d="down";else if(3==c)d="right";else{if(4!=c)continue;var d="left"}var v=(n=moveCordsOneBlock(d,r,i)).x,f=n.y;(blockIsOpenAndExists(e,v,f)||blockHasClass("start",e,v,f))&&l++}if(1==l)return{boolean:!0,fillHoleSide:a}}}return{boolean:!1}}function thinkTank(){if(0==activeBoards.length)return clearInterval(thinkTankLoop_timer),void(thinkTankLoop_timer=0);for(n=0;n<activeBoards.length;n++){var e=activeBoards[n],o=parseInt($("#"+e+" .active").attr("x")),t=parseInt($("#"+e+" .active").attr("y")),s=viewBlockMoveOptions(e,o,t),a="none";if(0==s.legitMoves.length)for(var n=1;n<=4;n++){if(1==n)r="up";else if(2==n)r="down";else if(3==n)r="right";else{if(4!=n){console.log("thinkTank():"+e+": has no where to move, finished"),boardFinished(e);continue}var r="left"}s[r].ranIntoStartBlock&&(a=r,$("#"+e+" .start").removeClass("on").addClass("off"))}else 1==s.legitMoves.length&&(a=s.legitMoves[0]);var i=doHolesNeedToBeFilled(e);if(i.boolean&&(a=i.fillHoleSide),"none"==a){for(var l=[],c=parseInt($("#"+e+" .active").attr("x")),d=parseInt($("#"+e+" .active").attr("y"));s.legitMoves.length>=1;){var v=moveCordsOneBlock(r=s.legitMoves[0],c,d),f=traverseAllPathsIsPossible(e,o=parseInt(v.x),t=parseInt(v.y));if(0==f.boolean){if("opposite"==(p=f.openOn))var p=getOppositeDirections(r).opp;var k=s.legitMoves.indexOf(p);if(-1!=k){v=moveCordsOneBlock(p,c,d);if(traverseAllPathsIsPossible(e,o=parseInt(v.x),t=parseInt(v.y)).boolean){a=p;break}s.legitMoves.splice(k,1)}}else l.push(r);s.legitMoves.shift()}"none"==a&&(a=closestMove(s,l))}moveToNext(e,a)}spliceFinishedBoards()}function thinkTankLoop(){0==thinkTankLoop_timer?(thinkTankLoop_timer=1,thinkTankLoop_timer=setInterval(function(){thinkTank()},CONSTANT_loopSpeed)):(clearInterval(thinkTankLoop_timer),thinkTankLoop_timer=0)}activeOpenBlockArray=[],boardsToSplice=[],thinkTankLoop_timer=0,activeBoards=[],CONSTANT_height=parseInt($(".easyVar.height").text()),CONSTANT_width=parseInt($(".easyVar.width").text()),CONSTANT_loopSpeed=parseInt($(".easyVar.speed").text()),CONSTANT_boardsToCreate=parseInt($(".easyVar.boards").text());for(var i=0;i<CONSTANT_boardsToCreate;i++){var foo="place"+i;createBoard(foo,CONSTANT_height,CONSTANT_width)}$(document).on("click",".board",function(){$(this).hasClass("selected")?$(".board").removeClass("selected"):($(".board").removeClass("selected"),$(this).addClass("selected"))}),window.addEventListener("keydown",function(e){[32,37,38,39,40].indexOf(e.keyCode)>-1&&e.preventDefault()},!1),$("#new").on("click",function(){$(".board").remove(),activeBoards=[],activeOpenBlockArray=[],boardsToSplice=[];for(var e=0;e<CONSTANT_boardsToCreate;e++)createBoard("place"+e,CONSTANT_height,CONSTANT_width)}),$("#playButton").on("click",function(){thinkTankLoop()}),$("body").on("keyup",function(e){switch(e.keyCode){case 32:o="space";break;case 93:o="command";break;case 39:var o="right",t=$(".selected").attr("id");break;case 37:var o="left",t=$(".selected").attr("id");break;case 38:var o="up",t=$(".selected").attr("id");break;case 40:var o="down",t=$(".selected").attr("id");break;default:return}"command"!=o?"space"!=o?$(".selected").length&&moveToNext(t,o,1):thinkTankLoop():thinkTank()});
</script>	
</html>




